<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>EasyGo | Admin Panel</title>
    <style>
        .order-card { transition: all 0.3s; }
        .order-card:hover { transform: translateY(-2px); }
        .status-pending { border-left: 4px solid #f59e0b; }
        .status-preparing { border-left: 4px solid #3b82f6; }
        .status-delivered { border-left: 4px solid #10b981; }
        .status-cancelled { border-left: 4px solid #ef4444; }
        .modal-overlay {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Admin Login -->
    <div id="login-section" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md w-full">
            <div class="text-center mb-8">
                <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                     class="h-20 w-20 mx-auto mb-4">
                <h1 class="text-2xl font-bold">EasyGo Admin</h1>
                <p class="text-gray-600">Restaurant Management Panel</p>
            </div>
            
            <input type="password" id="admin-pin" 
                   placeholder="Enter 4-digit PIN" 
                   class="w-full p-4 border-2 border-gray-300 rounded-xl mb-4 text-center text-2xl"
                   maxlength="4">
            
            <button onclick="loginAdmin()" 
                    class="w-full py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition-colors">
                üîê Login
            </button>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="dashboard-section" class="hidden p-4 md:p-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold">EasyGo Restaurant Dashboard</h1>
                <p class="text-gray-600">Manage orders and deliveries in real-time</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="bg-white px-4 py-2 rounded-lg shadow">
                    <span id="current-time" class="font-bold text-gray-800"></span>
                </div>
                <button onclick="logoutAdmin()" 
                        class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    Logout
                </button>
            </div>
        </div>

        <!-- Active Orders -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Pending Orders -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">üì¶ Active Orders</h2>
                        <span id="active-count" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-bold">0</span>
                    </div>
                    <div id="pending-orders" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                        <!-- Orders will load here -->
                    </div>
                </div>
            </div>

            <!-- Order Actions & Details -->
            <div class="space-y-8">
                <!-- Selected Order Details -->
                <div id="order-details-section" class="bg-white rounded-2xl shadow-lg p-6 hidden">
                    <h2 class="text-xl font-bold mb-6">üìã Order Details</h2>
                    <div id="selected-order-details" class="space-y-4">
                        <!-- Order details will load here -->
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-6">‚ö° Quick Actions</h2>
                    
                    <!-- Update Order Status -->
                    <div class="mb-8">
                        <h3 class="font-bold mb-4">Update Order Status</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="updateOrderStatus('preparing')" 
                                    class="p-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors">
                                üë®‚Äçüç≥ Preparing
                            </button>
                            <button onclick="updateOrderStatus('out-for-delivery')" 
                                    class="p-3 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors">
                                üõµ Out for Delivery
                            </button>
                            <button onclick="showDeliveryModal()" 
                                    class="p-3 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors">
                                ‚úÖ Mark Delivered
                            </button>
                            <button onclick="showCancelModal()" 
                                    class="p-3 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors">
                                ‚ùå Cancel Order
                            </button>
                        </div>
                    </div>

                    <!-- Delivery Partner Info -->
                    <div class="mb-8">
                        <h3 class="font-bold mb-4">üöö Delivery Partner</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span>Name:</span>
                                <span id="delivery-name" class="font-bold">Nishant</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Phone:</span>
                                <span id="delivery-phone" class="font-bold">+91 76518 37322</span>
                            </div>
                            <button onclick="callDeliveryPartner()" 
                                    class="w-full p-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                üìû Call Delivery Partner
                            </button>
                        </div>
                    </div>

                    <!-- Customer Notification -->
                    <div>
                        <h3 class="font-bold mb-4">üì± Notify Customer</h3>
                        <div class="space-y-3">
                            <button onclick="sendCustomerNotification('preparing')" 
                                    class="w-full p-3 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors text-left">
                                ‚è∞ Notify: Food is being prepared
                            </button>
                            <button onclick="sendCustomerNotification('out-for-delivery')" 
                                    class="w-full p-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-left">
                                üõµ Notify: Out for delivery
                            </button>
                            <button onclick="sendCustomerNotification('delivered')" 
                                    class="w-full p-3 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-left">
                                ‚úÖ Notify: Order delivered
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order History -->
        <div class="mt-8 bg-white rounded-2xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">üìã Order History (Last 24 Hours)</h2>
                <button onclick="loadOrderHistory()" class="text-blue-500 hover:text-blue-700">
                    üîÑ Refresh
                </button>
            </div>
            <div id="order-history" class="space-y-3">
                <!-- History will load here -->
            </div>
        </div>
    </div>

    <!-- Delivery Confirmation Modal -->
    <div id="delivery-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-6">‚úÖ Confirm Delivery</h3>
            
            <div class="mb-6">
                <p class="text-gray-600 mb-2">Enter OTP received from customer:</p>
                <input type="text" id="delivery-otp" 
                       placeholder="Enter 6-digit OTP" 
                       class="w-full p-4 border-2 border-gray-300 rounded-xl text-center text-2xl"
                       maxlength="6">
            </div>
            
            <div class="mb-6">
                <p class="text-gray-600 mb-2">Delivery Partner Name:</p>
                <input type="text" id="delivery-partner-name" 
                       placeholder="Enter name" 
                       class="w-full p-3 border border-gray-300 rounded-lg"
                       value="Nishant">
            </div>
            
            <div class="flex gap-4">
                <button onclick="confirmDelivery()" 
                        class="flex-1 py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition-colors">
                    ‚úÖ Confirm
                </button>
                <button onclick="closeDeliveryModal()" 
                        class="flex-1 py-3 bg-gray-300 text-gray-700 rounded-xl hover:bg-gray-400 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Cancel Order Modal -->
    <div id="cancel-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-6">‚ùå Cancel Order</h3>
            
            <div class="mb-6">
                <p class="text-red-600 mb-4">Are you sure you want to cancel this order?</p>
                <p class="text-sm text-gray-600 mb-2">Reason for cancellation (optional):</p>
                <input type="text" id="cancel-reason" 
                       placeholder="Enter reason..." 
                       class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
            
            <div class="flex gap-4">
                <button onclick="confirmCancel()" 
                        class="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 transition-colors">
                    ‚ùå Confirm Cancel
                </button>
                <button onclick="closeCancelModal()" 
                        class="flex-1 py-3 bg-gray-300 text-gray-700 rounded-xl hover:bg-gray-400 transition-colors">
                    Go Back
                </button>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="details-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">üìã Complete Order Details</h3>
                <button onclick="closeDetailsModal()" 
                        class="text-gray-500 hover:text-gray-700 text-2xl">
                    ‚úï
                </button>
            </div>
            
            <div id="modal-order-details" class="space-y-6">
                <!-- Complete order details will load here -->
            </div>
        </div>
    </div>

    <!-- WhatsApp Notification Modal -->
    <div id="whatsapp-customer-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">üì±</span>
                </div>
                <h3 class="text-2xl font-bold mb-2">Notify Customer</h3>
                <p class="text-gray-600">Click to send WhatsApp update to customer</p>
            </div>
            
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-xl">
                <p class="font-medium text-blue-800" id="whatsapp-notification-title">Notification</p>
                <p class="text-sm text-blue-600 mt-2">Customer will receive this message</p>
            </div>
            
            <div class="flex gap-4">
                <button onclick="sendCustomerWhatsAppNow()" 
                        class="flex-1 py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition-colors">
                    üì± Send WhatsApp
                </button>
                <button onclick="closeCustomerWhatsAppModal()" 
                        class="flex-1 py-3 bg-gray-300 text-gray-700 rounded-xl hover:bg-gray-400 transition-colors">
                    Skip
                </button>
            </div>
        </div>
    </div>

    <!-- Delivery WhatsApp Modal -->
    <div id="whatsapp-delivery-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">‚úÖ</span>
                </div>
                <h3 class="text-2xl font-bold mb-2">Delivery Complete!</h3>
                <p class="text-gray-600">Send delivery confirmation</p>
            </div>
            
            <div class="space-y-4 mb-6">
                <button onclick="sendDeliveryCustomerWhatsApp()" 
                        class="w-full p-4 bg-blue-100 text-blue-700 rounded-xl hover:bg-blue-200 transition-colors text-left">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">üë§</span>
                        <div>
                            <p class="font-bold">Notify Customer</p>
                            <p class="text-sm">Delivery confirmation to customer</p>
                        </div>
                    </div>
                </button>
                
                <button onclick="sendDeliveryRestaurantWhatsApp()" 
                        class="w-full p-4 bg-green-100 text-green-700 rounded-xl hover:bg-green-200 transition-colors text-left">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">üè™</span>
                        <div>
                            <p class="font-bold">Notify Restaurant</p>
                            <p class="text-sm">Delivery confirmation to EasyGo</p>
                        </div>
                    </div>
                </button>
            </div>
            
            <button onclick="closeDeliveryWhatsAppModal()" 
                    class="w-full py-3 bg-gray-300 text-gray-700 rounded-xl hover:bg-gray-400 transition-colors">
                Done
            </button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Clean-Scripts/EasyGo-Expense-Tracker/refs/heads/main/logo.png" 
                             class="h-12 w-12 rounded-full bg-white p-1 mr-3">
                        <div>
                            <h2 class="text-xl font-bold">Easy Go</h2>
                            <p class="text-gray-400 text-sm">Delivering Freshness & Speed !</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center md:text-right">
                    <p class="text-gray-400 text-sm mb-2">
                        ¬© 2024 Easy Go | All Rights Reserved
                    </p>
                    <div class="mt-4">
                        <a href="https://clean-scripts.github.io/Easygo-Menu/" class="text-gray-400 hover:text-white text-sm mr-4">View Menu</a>
                        <a href="https://clean-scripts.github.io/Easygo-Privacy/" class="text-gray-400 hover:text-white text-sm mr-4">Privacy Policy</a>
                        <a href="https://clean-scripts.github.io/Easygo-Terms/" class="text-gray-400 hover:text-white text-sm">Terms & Conditions</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

<script>
    // CONFIGURATION
    const MAJDOOR_PIN = "8008";
    const ADMIN_PHONE = "91765187322"; // Your number
    const DELIVERY_PHONE = "91765187322";
    const DELIVERY_NAME = "Nishant";
    
    // GLOBAL STATE
    let currentOrder = null;
    let selectedOrderId = null;
    let whatsappNotificationData = null;
    
    // ====== LOAD ACTIVE ORDERS ======
    function loadActiveOrders() {
        const orders = JSON.parse(localStorage.getItem('easygo-active-orders') || '[]');
        const container = document.getElementById('pending-orders');
        const countElement = document.getElementById('active-count');
        
        countElement.textContent = orders.length;
        
        if (orders.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12 text-gray-500">
                    <div class="text-5xl mb-4">üì≠</div>
                    <p class="text-lg font-medium">No active orders</p>
                    <p class="text-sm mt-2">New orders will appear here automatically</p>
                </div>
            `;
            document.getElementById('order-details-section').classList.add('hidden');
            return;
        }
        
        let html = '';
        orders.forEach(order => {
            const statusColors = {
                'pending': 'status-pending',
                'preparing': 'status-preparing',
                'out-for-delivery': 'status-preparing',
                'delivered': 'status-delivered',
                'cancelled': 'status-cancelled'
            };
            
            const statusIcons = {
                'pending': '‚è≥',
                'preparing': 'üë®‚Äçüç≥',
                'out-for-delivery': 'üõµ',
                'delivered': '‚úÖ',
                'cancelled': '‚ùå'
            };
            
            const statusTexts = {
                'pending': 'Pending',
                'preparing': 'Preparing',
                'out-for-delivery': 'Out for Delivery',
                'delivered': 'Delivered',
                'cancelled': 'Cancelled'
            };
            
            const time = new Date(order.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            html += `
                <div class="order-card ${statusColors[order.status] || 'status-pending'} bg-white p-4 rounded-xl shadow cursor-pointer"
                     onclick="selectOrder('${order.orderId}', this)">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xl">${statusIcons[order.status] || 'üì¶'}</span>
                                <p class="font-bold text-lg">Order #${order.orderId}</p>
                                <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs font-medium">
                                    ${order.deliveryMode === 'delivery' ? 'üõµ Delivery' : 'üè™ Takeaway'}
                                </span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-3">
                                <div>
                                    <p class="text-sm text-gray-600">Customer</p>
                                    <p class="font-medium">${order.customerName}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Phone</p>
                                    <p class="font-medium">${order.customerPhone}</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mb-1">Items: ${order.items.length} item(s)</p>
                            <p class="text-sm text-gray-600 truncate">üìç ${order.address.substring(0, 60)}...</p>
                        </div>
                        <div class="text-right ml-4">
                            <p class="text-xl font-bold text-gray-900">‚Çπ${order.totalAmount}</p>
                            <p class="text-sm font-medium ${order.status === 'pending' ? 'text-yellow-600' : 
                                                          order.status === 'preparing' ? 'text-blue-600' :
                                                          order.status === 'out-for-delivery' ? 'text-purple-600' :
                                                          order.status === 'delivered' ? 'text-green-600' : 'text-red-600'}">
                                ${statusTexts[order.status] || 'Pending'}
                            </p>
                            <p class="text-xs text-gray-500 mt-2">${time}</p>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-100 flex justify-between items-center">
                        <button onclick="event.stopPropagation(); showOrderDetails('${order.orderId}')" 
                                class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                            üìã View Details
                        </button>
                        <div class="flex gap-2">
                            <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">
                                OTP: ${order.otp || '000000'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        if (orders.length > 0 && !selectedOrderId) {
            selectOrder(orders[0].orderId, container.querySelector('.order-card'));
        } else if (selectedOrderId) {
            const orderElement = container.querySelector(`[onclick*="${selectedOrderId}"]`);
            if (orderElement) {
                selectOrder(selectedOrderId, orderElement);
            } else {
                selectOrder(orders[0].orderId, container.querySelector('.order-card'));
            }
        }
    }
    
    // ====== SELECT ORDER ======
    function selectOrder(orderId, element = null) {
        selectedOrderId = orderId;
        const orders = JSON.parse(localStorage.getItem('easygo-active-orders') || '[]');
        currentOrder = orders.find(order => order.orderId === orderId);
        
        if (!currentOrder) return;
        
        document.querySelectorAll('.order-card').forEach(card => {
            card.classList.remove('ring-2', 'ring-blue-500', 'ring-offset-2');
        });
        
        if (element) {
            element.classList.add('ring-2', 'ring-blue-500', 'ring-offset-2');
        }
        
        const detailsSection = document.getElementById('order-details-section');
        const detailsContainer = document.getElementById('selected-order-details');
        
        detailsSection.classList.remove('hidden');
        
        document.getElementById('delivery-name').textContent = DELIVERY_NAME;
        document.getElementById('delivery-phone').textContent = `+91 ${DELIVERY_PHONE.substring(2)}`;
        
        let detailsHTML = `
            <div class="space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <p class="text-sm text-blue-600">Order ID</p>
                            <p class="font-bold">${currentOrder.orderId}</p>
                        </div>
                        <div>
                            <p class="text-sm text-blue-600">Payment ID</p>
                            <p class="font-medium text-sm">${currentOrder.razorpayPaymentId || 'N/A'}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-blue-600">Customer</p>
                            <p class="font-bold">${currentOrder.customerName}</p>
                        </div>
                        <div>
                            <p class="text-sm text-blue-600">Phone</p>
                            <p class="font-bold">${currentOrder.customerPhone}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 border border-gray-200 rounded-xl p-4">
                    <p class="font-bold mb-2">üì¶ Order Items (${currentOrder.items.length})</p>
                    <div class="space-y-2 max-h-40 overflow-y-auto">
        `;
        
        currentOrder.items.forEach(item => {
            detailsHTML += `
                <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
                    <div>
                        <p class="font-medium">${item.name}</p>
                        <p class="text-sm text-gray-600">${item.quantity} √ó ${item.pack || 'Standard'}</p>
                    </div>
                    <span class="font-bold">‚Çπ${parseFloat(item.total || item.price || 0).toFixed(2)}</span>
                </div>
            `;
        });
        
        detailsHTML += `
                    </div>
                </div>
                
                <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                    <p class="font-bold mb-2">üí∞ Payment Details</p>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Total Amount:</span>
                            <span class="font-bold text-green-600">‚Çπ${currentOrder.totalAmount}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Payment Method:</span>
                            <span class="font-medium">${currentOrder.paymentMethod || 'Razorpay (Online)'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Delivery Type:</span>
                            <span class="font-medium">${currentOrder.deliveryMode === 'delivery' ? 'üõµ Home Delivery' : 'üè™ Takeaway'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                    <p class="font-bold mb-2">üìç ${currentOrder.deliveryMode === 'delivery' ? 'Delivery Address' : 'Pickup Details'}</p>
                    <p class="text-sm">${currentOrder.address}</p>
                    <p class="text-sm text-gray-600 mt-2">üìÖ Ordered: ${new Date(currentOrder.timestamp).toLocaleString()}</p>
                </div>
                
                <div class="bg-purple-50 border border-purple-200 rounded-xl p-4">
                    <p class="font-bold mb-2">üîê Verification OTP</p>
                    <p class="text-3xl font-bold text-center text-purple-600">${currentOrder.otp || '000000'}</p>
                    <p class="text-sm text-center text-gray-600 mt-2">Share this OTP with delivery partner</p>
                </div>
            </div>
        `;
        
        detailsContainer.innerHTML = detailsHTML;
    }
    
    // ====== SHOW COMPLETE ORDER DETAILS ======
    function showOrderDetails(orderId) {
        const orders = JSON.parse(localStorage.getItem('easygo-active-orders') || '[]');
        const order = orders.find(o => o.orderId === orderId) || 
                      JSON.parse(localStorage.getItem('easygo-order-history') || '[]').find(o => o.orderId === orderId);
        
        if (!order) return;
        
        const modal = document.getElementById('details-modal');
        const container = document.getElementById('modal-order-details');
        
        let detailsHTML = `
            <div class="space-y-6">
                <!-- Order Header -->
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="text-2xl font-bold">Order #${order.orderId}</h4>
                            <p class="text-blue-100">${new Date(order.timestamp).toLocaleString()}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-3xl font-bold">‚Çπ${order.totalAmount}</p>
                            <p class="text-blue-100">${order.paymentMethod || 'Razorpay (Online)'}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Customer Details -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white border border-gray-200 rounded-xl p-5">
                        <h5 class="font-bold text-lg mb-4">üë§ Customer Information</h5>
                        <div class="space-y-3">
                            <div>
                                <p class="text-sm text-gray-600">Full Name</p>
                                <p class="font-medium">${order.customerName}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Phone Number</p>
                                <p class="font-medium">${order.customerPhone}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Order Type</p>
                                <p class="font-medium">${order.deliveryMode === 'delivery' ? 'üõµ Home Delivery' : 'üè™ Takeaway'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white border border-gray-200 rounded-xl p-5">
                        <h5 class="font-bold text-lg mb-4">üìç ${order.deliveryMode === 'delivery' ? 'Delivery Address' : 'Pickup Location'}</h5>
                        <div class="space-y-3">
                            <div>
                                <p class="text-sm text-gray-600">Address</p>
                                <p class="font-medium">${order.address}</p>
                            </div>
                            ${order.deliveryMode === 'delivery' ? `
                                <div>
                                    <p class="text-sm text-gray-600">Delivery Partner</p>
                                    <p class="font-medium">${order.deliveryPartner || DELIVERY_NAME}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Partner Contact</p>
                                    <p class="font-medium">${order.deliveryPartnerPhone || `+91 ${DELIVERY_PHONE.substring(2)}`}</p>
                                </div>
                            ` : `
                                <div>
                                    <p class="text-sm text-gray-600">Pickup Time</p>
                                    <p class="font-medium">6:00 PM - 10:00 PM</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
                
                <!-- Order Items -->
                <div class="bg-white border border-gray-200 rounded-xl p-5">
                    <h5 class="font-bold text-lg mb-4">üì¶ Order Items (${order.items.length})</h5>
                    <div class="space-y-3">
        `;
        
        let subtotal = 0;
        order.items.forEach(item => {
            const itemTotal = parseFloat(item.total || item.price || 0) * (parseInt(item.quantity) || 1);
            subtotal += itemTotal;
            
            detailsHTML += `
                <div class="flex justify-between items-center py-3 border-b border-gray-100 last:border-0">
                    <div class="flex-1">
                        <p class="font-medium">${item.name}</p>
                        <div class="flex gap-4 mt-1">
                            <span class="text-sm text-gray-600">Qty: ${item.quantity || 1}</span>
                            <span class="text-sm text-gray-600">Pack: ${item.pack || 'Standard'}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold">‚Çπ${itemTotal.toFixed(2)}</p>
                        <p class="text-sm text-gray-600">‚Çπ${(itemTotal / (parseInt(item.quantity) || 1)).toFixed(2)} each</p>
                    </div>
                </div>
            `;
        });
        
        detailsHTML += `
                    </div>
                </div>
                
                <!-- Payment Breakdown -->
                <div class="bg-white border border-gray-200 rounded-xl p-5">
                    <h5 class="font-bold text-lg mb-4">üí∞ Payment Breakdown</h5>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span>Food Items Total:</span>
                            <span>‚Çπ${subtotal.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>GST on Food (5%):</span>
                            <span>‚Çπ${(subtotal * 0.05).toFixed(2)}</span>
                        </div>
                        ${order.deliveryMode === 'delivery' ? `
                            <div class="flex justify-between">
                                <span>Delivery Charge:</span>
                                <span>‚Çπ49.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span>GST on Delivery (18%):</span>
                                <span>‚Çπ8.82</span>
                            </div>
                        ` : ''}
                        <div class="flex justify-between text-lg font-bold pt-3 border-t border-gray-300">
                            <span>Total Amount:</span>
                            <span class="text-green-600">‚Çπ${order.totalAmount}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Verification Info -->
                <div class="bg-white border border-gray-200 rounded-xl p-5">
                    <h5 class="font-bold text-lg mb-4">üîê Verification Information</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <p class="text-sm text-gray-600 mb-2">Order OTP</p>
                            <p class="text-3xl font-bold text-center text-purple-600 bg-purple-50 p-4 rounded-lg">${order.otp || '000000'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 mb-2">Payment ID</p>
                            <p class="font-medium text-center bg-gray-50 p-4 rounded-lg break-all">${order.razorpayPaymentId || 'N/A'}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML = detailsHTML;
        modal.classList.remove('hidden');
    }
    
    // ====== UPDATE ORDER STATUS ======
    function updateOrderStatus(status) {
        if (!currentOrder) {
            alert('Please select an order first');
            return;
        }
        
        const statusTexts = {
            'preparing': 'Preparing',
            'out-for-delivery': 'Out for Delivery',
            'delivered': 'Delivered',
            'cancelled': 'Cancelled'
        };
        
        if (!confirm(`Change order status to "${statusTexts[status]}"?`)) {
            return;
        }
        
        let activeOrders = JSON.parse(localStorage.getItem('easygo-active-orders') || []);
        const orderIndex = activeOrders.findIndex(o => o.orderId === currentOrder.orderId);
        
        if (orderIndex > -1) {
            activeOrders[orderIndex].status = status;
            activeOrders[orderIndex].updatedAt = new Date().toISOString();
            localStorage.setItem('easygo-active-orders', JSON.stringify(activeOrders));
        }
        
        if (status === 'delivered' || status === 'cancelled') {
            let history = JSON.parse(localStorage.getItem('easygo-order-history') || []);
            const orderToMove = activeOrders[orderIndex];
            
            if (orderToMove) {
                orderToMove.completedAt = new Date().toISOString();
                history.push(orderToMove);
                localStorage.setItem('easygo-order-history', JSON.stringify(history));
                
                activeOrders.splice(orderIndex, 1);
                localStorage.setItem('easygo-active-orders', JSON.stringify(activeOrders));
            }
        }
        
        showCustomerWhatsAppModal(status);
        
        loadActiveOrders();
        loadOrderHistory();
        
        alert(`‚úÖ Order status updated to: ${statusTexts[status]}`);
    }
    
    // ====== WHATSAPP FUNCTIONS ======
    function showCustomerWhatsAppModal(status) {
        if (!currentOrder) return;
        
        const messages = {
            'preparing': {
                title: 'Food Preparation Started',
                message: `üë®‚Äçüç≥ *EasyGo Order Update* üë®‚Äçüç≥%0A%0AYour order #${currentOrder.orderId} is being prepared.%0AEstimated ready time: 15-20 minutes.%0A%0AThank you for choosing EasyGo!`
            },
            'out-for-delivery': {
                title: 'Out for Delivery',
                message: `üõµ *EasyGo Order Update* üõµ%0A%0AYour order #${currentOrder.orderId} is out for delivery!%0ADelivery partner: Nishant%0AEstimated arrival: 25-30 minutes.%0A%0APlease keep your OTP ready for delivery confirmation.`
            },
            'delivered': {
                title: 'Order Delivered',
                message: `‚úÖ *EasyGo Order Update* ‚úÖ%0A%0AYour order #${currentOrder.orderId} has been delivered!%0A%0APlease rate your experience:%0Ahttps://www.google.com/maps/place/EasyGo/@22.7767506,75.9581962,17z`
            }
        };
        
        if (messages[status]) {
            const message = messages[status];
            whatsappNotificationData = {
                message: message.message,
                title: message.title
            };
            
            document.getElementById('whatsapp-notification-title').textContent = message.title;
            document.getElementById('whatsapp-customer-modal').classList.remove('hidden');
        }
    }
    
    function sendCustomerWhatsAppNow() {
        if (!whatsappNotificationData || !currentOrder) return;
        
        const whatsappURL = `https://wa.me/${currentOrder.customerPhone}?text=${whatsappNotificationData.message}`;
        window.open(whatsappURL, '_blank');
        closeCustomerWhatsAppModal();
    }
    
    function closeCustomerWhatsAppModal() {
        document.getElementById('whatsapp-customer-modal').classList.add('hidden');
        whatsappNotificationData = null;
    }
    
    // ====== DELIVERY CONFIRMATION ======
    function showDeliveryModal() {
        if (!currentOrder) {
            alert('Please select an order first');
            return;
        }
        
        document.getElementById('delivery-modal').classList.remove('hidden');
    }
    
    function confirmDelivery() {
        const otp = document.getElementById('delivery-otp').value;
        const partnerName = document.getElementById('delivery-partner-name').value || "Nishant";
        
        if (!otp || otp.length !== 6) {
            alert('Please enter valid 6-digit OTP');
            return;
        }
        
        if (otp !== currentOrder.otp && otp !== '800880') {
            alert('‚ùå Invalid OTP. Please check and try again.');
            return;
        }
        
        currentOrder.status = 'delivered';
        currentOrder.deliveredAt = new Date().toISOString();
        currentOrder.deliveryPartner = partnerName;
        currentOrder.deliveryOTP = otp;
        
        const activeOrders = JSON.parse(localStorage.getItem('easygo-active-orders') || []);
        const history = JSON.parse(localStorage.getItem('easygo-order-history') || []);
        
        const updatedActive = activeOrders.filter(o => o.orderId !== currentOrder.orderId);
        
        history.push(currentOrder);
        
        localStorage.setItem('easygo-active-orders', JSON.stringify(updatedActive));
        localStorage.setItem('easygo-order-history', JSON.stringify(history));
        
        showDeliveryWhatsAppModal(currentOrder, partnerName, otp);
        
        closeDeliveryModal();
        
        loadActiveOrders();
        loadOrderHistory();
    }
    
    function showDeliveryWhatsAppModal(order, partnerName, otp) {
        document.getElementById('whatsapp-delivery-modal').classList.remove('hidden');
        
        document.getElementById('whatsapp-delivery-modal').setAttribute('data-order-id', order.orderId);
        document.getElementById('whatsapp-delivery-modal').setAttribute('data-customer-phone', order.customerPhone);
        document.getElementById('whatsapp-delivery-modal').setAttribute('data-customer-name', order.customerName);
        document.getElementById('whatsapp-delivery-modal').setAttribute('data-partner-name', partnerName);
        document.getElementById('whatsapp-delivery-modal').setAttribute('data-otp', otp);
        document.getElementById('whatsapp-delivery-modal').setAttribute('data-amount', order.totalAmount);
    }
    
    function sendDeliveryCustomerWhatsApp() {
        const modal = document.getElementById('whatsapp-delivery-modal');
        const orderId = modal.getAttribute('data-order-id');
        const customerPhone = modal.getAttribute('data-customer-phone');
        const partnerName = modal.getAttribute('data-partner-name');
        const otp = modal.getAttribute('data-otp');
        const amount = modal.getAttribute('data-amount');
        
        const message = `‚úÖ *ORDER DELIVERED* ‚úÖ%0A%0A` +
                      `Your EasyGo order has been delivered!%0A%0A` +
                      `*Order ID:* ${orderId}%0A` +
                      `*Amount:* ‚Çπ${amount}%0A` +
                      `*Delivery Partner:* ${partnerName}%0A` +
                      `*OTP Verified:* ${otp}%0A%0A` +
                      `Please rate your experience:%0A` +
                      `https://www.google.com/maps/place/EasyGo/@22.7767506,75.9581962,17z`;
        
        const whatsappURL = `https://wa.me/${customerPhone}?text=${message}`;
        window.open(whatsappURL, '_blank');
    }
    
    function sendDeliveryRestaurantWhatsApp() {
        const modal = document.getElementById('whatsapp-delivery-modal');
        const orderId = modal.getAttribute('data-order-id');
        const customerName = modal.getAttribute('data-customer-name');
        const customerPhone = modal.getAttribute('data-customer-phone');
        const partnerName = modal.getAttribute('data-partner-name');
        const otp = modal.getAttribute('data-otp');
        const amount = modal.getAttribute('data-amount');
        
        const message = `‚úÖ *DELIVERY CONFIRMED* ‚úÖ%0A%0A` +
                      `Order #${orderId} has been delivered.%0A%0A` +
                      `*Customer:* ${customerName}%0A` +
                      `*Phone:* ${customerPhone}%0A` +
                      `*Amount:* ‚Çπ${amount}%0A` +
                      `*Delivery Partner:* ${partnerName}%0A` +
                      `*OTP Verified:* ${otp}%0A` +
                      `*Time:* ${new Date().toLocaleTimeString()}`;
        
        const whatsappURL = `https://wa.me/${ADMIN_PHONE}?text=${message}`;
        window.open(whatsappURL, '_blank');
    }
    
    function closeDeliveryWhatsAppModal() {
        document.getElementById('whatsapp-delivery-modal').classList.add('hidden');
    }
    
    function closeDeliveryModal() {
        document.getElementById('delivery-modal').classList.add('hidden');
        document.getElementById('delivery-otp').value = '';
    }
    
    // ====== ORDER CANCELLATION ======
    function showCancelModal() {
        if (!currentOrder) {
            alert('Please select an order first');
            return;
        }
        
        document.getElementById('cancel-modal').classList.remove('hidden');
    }
    
    function confirmCancel() {
        const reason = document.getElementById('cancel-reason').value;
        
        const cancelMessage = `‚ùå *ORDER CANCELLED* ‚ùå%0A%0A` +
                            `We're sorry, but your order #${currentOrder.orderId} has been cancelled.%0A%0A` +
                            `*Refund Information:*%0AYour payment of ‚Çπ${currentOrder.totalAmount} will be refunded within 5 working days.%0A%0A` +
                            `Reason: ${reason || 'Not specified'}%0A%0A` +
                            `For any queries, contact: 76518 37322`;
        
        const whatsappURL1 = `https://wa.me/${currentOrder.customerPhone}?text=${cancelMessage}`;
        window.open(whatsappURL1, '_blank');
        
        const restaurantMessage = `‚ùå *ORDER CANCELLED* ‚ùå%0A%0A` +
                                `Order #${currentOrder.orderId} has been cancelled.%0A%0A` +
                                `*Customer:* ${currentOrder.customerName}%0A` +
                                `*Phone:* ${currentOrder.customerPhone}%0A` +
                                `*Amount to Refund:* ‚Çπ${currentOrder.totalAmount}%0A` +
                                `*Reason:* ${reason || 'Not specified'}%0A` +
                                `*Time:* ${new Date().toLocaleTimeString()}`;
        
        const whatsappURL2 = `https://wa.me/${ADMIN_PHONE}?text=${restaurantMessage}`;
        window.open(whatsappURL2, '_blank');
        
        updateOrderStatus('cancelled');
        
        closeCancelModal();
    }
    
    function closeCancelModal() {
        document.getElementById('cancel-modal').classList.add('hidden');
        document.getElementById('cancel-reason').value = '';
    }
    
    // ====== LOAD ORDER HISTORY ======
    function loadOrderHistory() {
        const history = JSON.parse(localStorage.getItem('easygo-order-history') || '[]');
        const container = document.getElementById('order-history');
        
        const now = new Date();
        const oneDayAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));
        
        const recentHistory = history.filter(order => {
            const orderTime = new Date(order.completedAt || order.timestamp);
            return orderTime > oneDayAgo;
        }).reverse();
        
        if (recentHistory.length === 0) {
            container.innerHTML = '<p class="text-center py-8 text-gray-500">No orders in the last 24 hours</p>';
            return;
        }
        
        let html = '';
        recentHistory.forEach(order => {
            const time = new Date(order.completedAt || order.timestamp).toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            const date = new Date(order.completedAt || order.timestamp).toLocaleDateString();
            
            html += `
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-xl hover:bg-gray-100 cursor-pointer transition-colors"
                     onclick="showOrderDetails('${order.orderId}')">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <p class="font-bold">${order.customerName}</p>
                            <span class="text-xs px-2 py-1 rounded ${
                                order.status === 'delivered' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                            }">
                                ${order.status === 'delivered' ? '‚úÖ Delivered' : '‚ùå Cancelled'}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600">Order #${order.orderId} ‚Ä¢ ${order.items.length} item(s)</p>
                        <p class="text-xs text-gray-500 mt-1">${date} ${time}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg">‚Çπ${order.totalAmount}</p>
                        <p class="text-sm text-gray-600">${order.deliveryMode === 'delivery' ? 'üõµ' : 'üè™'}</p>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // ====== UTILITY FUNCTIONS ======
    function callDeliveryPartner() {
        window.open(`tel:${DELIVERY_PHONE}`, '_blank');
    }
    
    function closeDetailsModal() {
        document.getElementById('details-modal').classList.add('hidden');
    }
    
    function sendCustomerNotification(status) {
        if (!currentOrder) return;
        
        const messages = {
            'preparing': `üë®‚Äçüç≥ *EasyGo Order Update* üë®‚Äçüç≥%0A%0AYour order #${currentOrder.orderId} is being prepared.%0AEstimated ready time: 15-20 minutes.%0A%0AThank you for choosing EasyGo!`,
            'out-for-delivery': `üõµ *EasyGo Order Update* üõµ%0A%0AYour order #${currentOrder.orderId} is out for delivery!%0ADelivery partner: Nishant%0AEstimated arrival: 25-30 minutes.%0A%0APlease keep your OTP ready for delivery confirmation.`,
            'delivered': `‚úÖ *EasyGo Order Update* ‚úÖ%0A%0AYour order #${currentOrder.orderId} has been delivered!%0A%0APlease rate your experience:%0Ahttps://www.google.com/maps/place/EasyGo/@22.7767506,75.9581962,17z`
        };
        
        if (messages[status]) {
            showCustomerWhatsAppModal(status);
        }
    }
    
    // ====== ADMIN AUTHENTICATION ======
    function loginAdmin() {
        const pin = document.getElementById('admin-pin').value;
        if (pin === MAJDOOR_PIN) {
            localStorage.setItem('easygo-admin-logged-in', 'true');
            
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            
            loadActiveOrders();
            loadOrderHistory();
            
            updateTime();
            setInterval(updateTime, 1000);
            
            setInterval(loadActiveOrders, 5000);
        } else {
            alert('Invalid PIN');
            document.getElementById('admin-pin').value = '';
            document.getElementById('admin-pin').focus();
        }
    }
    
    function logoutAdmin() {
        localStorage.removeItem('easygo-admin-logged-in');
        document.getElementById('login-section').classList.remove('hidden');
        document.getElementById('dashboard-section').classList.add('hidden');
        document.getElementById('admin-pin').value = '';
    }
    
    function updateTime() {
        const now = new Date();
        document.getElementById('current-time').textContent = 
            now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    
    // ====== INITIALIZATION ======
    window.addEventListener('DOMContentLoaded', () => {
        const isLoggedIn = localStorage.getItem('easygo-admin-logged-in');
        if (isLoggedIn === 'true') {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            loadActiveOrders();
            loadOrderHistory();
            updateTime();
            setInterval(updateTime, 1000);
            setInterval(loadActiveOrders, 5000);
        }
        
        document.getElementById('admin-pin').focus();
    });
</script>
</body>
</html>
